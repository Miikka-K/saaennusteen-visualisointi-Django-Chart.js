<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8">
  <title>Sääennuste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap tyylittelyä varten (valinnainen) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Chart.js komponenttikirjasto -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container py-4">
  <h1 class="mb-3">Sääennuste (7 pv)</h1>

  <form method="get" class="row g-2 mb-4">
    <div class="col-auto">
      <select name="city" class="form-select" onchange="this.form.submit()">
        {% for c in cities %}
          <option value="{{ c.id }}" {% if city and c.id == city.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
  </form>

  {% if city %}
    <div class="mb-3">
      <strong>Kaupunki:</strong> {{ city.name }}
    </div>

    <div class="row">
      <div class="col-12">
        <canvas id="forecastChart" height="120"></canvas>
      </div>
    </div>

    <h2 class="h5 mt-4">Taulukko</h2>
    <table class="table table-striped">
      <thead>
        <tr><th>Päivä</th><th>Min (°C)</th><th>Maks (°C)</th></tr>
      </thead>
      <tbody id="forecastTable"></tbody>
    </table>

    <script>
      // Data backendista
      const labels = {{ labels|safe }};
      const dataMax = {{ data_max|safe }};
      const dataMin = {{ data_min|safe }};

      // Täytetään taulukko
      const tbody = document.getElementById('forecastTable');
      tbody.innerHTML = labels.map((d, i) =>
        `<tr><td>${d}</td><td>${dataMin[i] ?? '-'}</td><td>${dataMax[i] ?? '-'}</td></tr>`
      ).join('');

      // Laske automaattinen skaala
      const minTemp = Math.min(...dataMin);
      const maxTemp = Math.max(...dataMax);
      const margin = 2; // lisää tilaa y-akselille

      // Chart.js line chart
      const ctx = document.getElementById('forecastChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { 
              label: 'Maksimi (°C)', 
              data: dataMax,  
              borderColor: 'red',
              backgroundColor: 'red',
              borderWidth: 1
            },
            { 
              label: 'Minimi (°C)', 
              data: dataMin, 
              tension: 0.25, 
              borderColor: 'blue',
              backgroundColor: 'blue',
              boorderWidth: 1
            },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { 
              title: { display: true, text: '°C' },
              min: minTemp - margin,
              max: maxTemp + margin
            },
            x: { title: { display: true, text: 'Päivä' } }
          },
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Lämpötilat seuraaville päiville' }
          }
        }
      });
    </script>
  {% else %}
    <p>Lisää ensin kaupunki.</p>
  {% endif %}
</body>
</html>
